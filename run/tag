#!/usr/bin/env ruby
description = 'Validates features that have a given tag'

basename = File.basename(__FILE__).to_s
if ARGV[0] == 'describe'
  puts "  #{basename.ljust(ARGV[1].to_i)} - #{description}"
  exit 0
elsif ARGV.length == 1 && ARGV[1] == '--help'
  puts <<HELP
Usage: run/#{basename} tag1[,tag2,tag3] [options]
Separate tags by a ',' (no spaces) to run more than one tag.
HELP
  exit 0
end

require 'rubygems'
require 'yaml'
require 'fileutils'
require 'uri'
require 'net/ssh/gateway'
require File.expand_path('../../features/support/cloud_configuration.rb', __FILE__)

include CloudConfiguration

@host = URI.parse(ConfigFile.web_client_url).host
def create_tunnel
  username = ConfigFile.tunnel_username || `whoami`.chomp
  abort 'ERROR: Username must be specified!' if username.to_s.empty?

  gateway = Net::SSH::Gateway.new(@host, username)
  gateway.open(@host, 35357, 35357)
  gateway.open(@host, 8776, 8776)
  gateway.open(@host, 9292, 9292)
  gateway.open(@host, 8774, 8774)
  gateway.open(@host, 8773, 8773)
  gateway.open(@host, 5000, 5000)
  gateway
end

if ConfigFile.tunnel
  begin
    print "Connecting to #{@host} via SSH tunnel... "
    @tunnel = create_tunnel
    puts 'Connected.'
  rescue => e
    abort "ERROR: #{e.inspect}"
  end
end

puts "Verifying requirements tagged with #{ARGV[0]}"
puts "Start at #{Time.now}"
system "bundle exec cucumber --no-profile --tags #{ARGV[0]} --require features --format Cucumber::Formatter::Bob::Html --out output --format rerun --out rerun.txt --format 'Slowhandcuke::Formatter'"
if @tunnel
  @tunnel.shutdown!
  puts "SSH tunnel closed."
end
puts "Finished at #{Time.now}"
